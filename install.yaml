name: ddev-kanopi-pantheon-drupal

# Based on https://github.com/ddev/ddev/blob/HEAD/pkg/ddevapp/addons.go#L61
project_files:
- commands/

# DDEV version constraint
ddev_version_constraint: ">= v1.22.0"

# Pre-install actions
pre_install_actions:
# Collect user input for configuration
- |
  #ddev-description:Collecting configuration for Kanopi Pantheon Drupal Add-on
  echo ""
  echo "ðŸ”§ Configuring Kanopi Pantheon Drupal Add-on..."
  echo ""
  
  # Check if running in non-interactive mode (for testing)
  if [ "${ADDON_NON_INTERACTIVE:-}" = "true" ]; then
    echo "ðŸ¤– Running in non-interactive mode (test environment)"
    
    # Use pre-set environment variables
    ADDON_THEME_PATH="${ADDON_THEME_PATH:-themes/custom/themename}"
    ADDON_THEME_NAME="${ADDON_THEME_NAME:-themename}"
    ADDON_PANTHEON_SITE="${ADDON_PANTHEON_SITE:-your-pantheon-site}"
    ADDON_PANTHEON_ENV="${ADDON_PANTHEON_ENV:-dev}"
    ADDON_MIGRATE_SOURCE="${ADDON_MIGRATE_SOURCE:-}"
    ADDON_MIGRATE_ENV="${ADDON_MIGRATE_ENV:-}"
    
    echo "ðŸ“ Theme path: $ADDON_THEME_PATH"
    echo "ðŸŽ¨ Theme name: $ADDON_THEME_NAME"
    echo "ðŸ›ï¸  Pantheon site: $ADDON_PANTHEON_SITE"
    echo "ðŸŒ Pantheon env: $ADDON_PANTHEON_ENV"
    echo "ðŸ“¦ Migration source: ${ADDON_MIGRATE_SOURCE:-'(not set)'}"
    echo "ðŸŒ Migration env: ${ADDON_MIGRATE_ENV:-'(not set)'}"
    
  else
    # Interactive mode - collect user input
    
    # THEME configuration
    printf "ðŸ“ Enter the path to your active Drupal theme (e.g., themes/custom/mytheme): "
    read ADDON_THEME_PATH
    if [ -z "$ADDON_THEME_PATH" ]; then
      ADDON_THEME_PATH="themes/custom/themename"
      echo "âš ï¸  Using default theme path: $ADDON_THEME_PATH"
    fi
    
    # THEMENAME configuration
    printf "ðŸŽ¨ Enter your theme name (e.g., mytheme): "
    read ADDON_THEME_NAME
    if [ -z "$ADDON_THEME_NAME" ]; then
      ADDON_THEME_NAME="themename"
      echo "âš ï¸  Using default theme name: $ADDON_THEME_NAME"
    fi
    
    # PANTHEON_SITE configuration
    printf "ðŸ›ï¸  Enter your Pantheon project machine name (e.g., my-site): "
    read ADDON_PANTHEON_SITE
    if [ -z "$ADDON_PANTHEON_SITE" ]; then
      echo "âŒ PANTHEON_SITE is required for proper functionality"
      exit 1
    fi
    
    # PANTHEON_ENV configuration
    printf "ðŸŒ Enter default Pantheon environment for database pulls (dev/test/live) [dev]: "
    read ADDON_PANTHEON_ENV
    if [ -z "$ADDON_PANTHEON_ENV" ]; then
      ADDON_PANTHEON_ENV="dev"
    fi
    
    echo ""
    echo "Optional Migration Configuration:"
    echo "Press Enter to skip if you don't need migration support"
    echo ""
    
    # MIGRATE_DB_SOURCE configuration (optional)
    printf "ðŸ“¦ Enter migration source Pantheon project name (optional): "
    read ADDON_MIGRATE_SOURCE
    
    # MIGRATE_DB_ENV configuration (optional)
    printf "ðŸŒ Enter migration source environment (dev/test/live) (optional): "
    read ADDON_MIGRATE_ENV
  fi
  
  # Export variables for post-install use
  export ADDON_THEME_PATH
  export ADDON_THEME_NAME
  export ADDON_PANTHEON_SITE
  export ADDON_PANTHEON_ENV
  export ADDON_MIGRATE_SOURCE
  export ADDON_MIGRATE_ENV
  
  echo ""
  echo "âœ… Configuration collected successfully"

# Post-install actions
post_install_actions:
# Apply the collected configuration and detect Pantheon settings
- |
  echo ""
  echo "âš™ï¸  Applying configuration..."
  
  # Apply collected configuration values with defaults
  ddev config --docroot=web
  ddev config --web-environment-add THEME=${ADDON_THEME_PATH:-themes/custom/themename}
  ddev config --web-environment-add THEMENAME=${ADDON_THEME_NAME:-themename}
  ddev config --web-environment-add PANTHEON_SITE=${ADDON_PANTHEON_SITE:-your-pantheon-site}
  ddev config --web-environment-add PANTHEON_ENV=${ADDON_PANTHEON_ENV:-dev}
  
  # Apply optional migration variables if provided
  if [ -n "${ADDON_MIGRATE_SOURCE:-}" ]; then
    ddev config --web-environment-add MIGRATE_DB_SOURCE=${ADDON_MIGRATE_SOURCE}
  fi
  
  if [ -n "${ADDON_MIGRATE_ENV:-}" ]; then
    ddev config --web-environment-add MIGRATE_DB_ENV=${ADDON_MIGRATE_ENV}
  fi
  
  echo "âœ… Configuration applied successfully"
  
  # Search for pantheon.yml and configure versions
  echo ""
  echo "ðŸ” Searching for pantheon.yml to configure PHP and database versions..."
  
  PANTHEON_YML=""
  # Search in common locations relative to project root
  for path in "pantheon.yml" "../pantheon.yml" "../../pantheon.yml"; do
    if [ -f "$path" ]; then
      PANTHEON_YML="$path"
      echo "âœ… Found pantheon.yml at: $path"
      break
    fi
  done
  
  if [ -n "$PANTHEON_YML" ]; then
    # Extract PHP version
    PHP_VERSION=$(grep "^php_version:" "$PANTHEON_YML" | sed 's/php_version: *//' | tr -d '"' || echo "")
    if [ -n "$PHP_VERSION" ]; then
      echo "ðŸ˜ Setting PHP version to: $PHP_VERSION"
      ddev config --php-version="$PHP_VERSION"
    fi
    
    # Extract database version
    DB_VERSION=$(grep -A1 "^database:" "$PANTHEON_YML" | grep "version:" | sed 's/.*version: *//' | tr -d '"' || echo "")
    if [ -n "$DB_VERSION" ]; then
      echo "ðŸ—„ï¸  Setting database version to: $DB_VERSION"
      # Get current database version to check if change is needed
      CURRENT_DB=$(grep -A3 "database:" .ddev/config.yaml | grep "version:" | sed 's/.*version: *//' | tr -d '"' || echo "")
      
      if [ "$CURRENT_DB" != "$DB_VERSION" ]; then
        echo "ðŸ“¦ Changing database from $CURRENT_DB to $DB_VERSION"
        # Stop DDEV first to allow database change
        echo "â¹ï¸  Stopping DDEV to change database version..."
        ddev stop || echo "âš ï¸  DDEV stop failed, continuing..."
        
        # Use DDEV's debug migrate-database command to handle version change
        echo "ðŸ”„ Migrating database to version $DB_VERSION..."
        if ! timeout 120 ddev debug migrate-database "mariadb:$DB_VERSION"; then
          echo "âš ï¸  Database migration failed or timed out, trying alternative approach..."
          # Alternative: delete database and reconfigure
          ddev delete --omit-snapshot --yes 2>/dev/null || true
          ddev config --database="mariadb:$DB_VERSION" || echo "âš ï¸  Database config failed"
        fi
        
        echo "ðŸ”„ Starting DDEV with database version $DB_VERSION..."
        if ! timeout 120 ddev start; then
          echo "âŒ DDEV start failed or timed out"
        fi
      else
        echo "âœ… Database version $DB_VERSION already configured"
      fi
    fi
    
    echo "âœ… Pantheon versions applied from pantheon.yml"
  else
    echo "â„¹ï¸  No pantheon.yml found, using default versions"
  fi
  
  # Install Redis add-on for all configurations
  echo ""
  echo "ðŸ“¦ Installing Redis add-on..."
  if ! timeout 180 ddev add-on get ddev/ddev-redis; then
    echo "âš ï¸  Redis add-on installation failed or timed out"
  else
    echo "âœ… Redis add-on installed successfully"
  fi
  
  # Install Solr add-on for search functionality
  echo ""
  echo "ðŸ“¦ Installing Solr add-on..."
  if ! timeout 180 ddev add-on get ddev/ddev-drupal-solr; then
    echo "âš ï¸  Solr add-on installation failed or timed out"
  else
    echo "âœ… Solr add-on installed successfully"
  fi

# Explain the installed components
- |
  echo ""
  echo "âœ… Kanopi Pantheon Drupal Add-on installed successfully!"
  echo ""
  echo "ðŸ“¦ Installed components:"
  echo "   â€¢ Enhanced Pantheon provider with smart backup management"
  echo "   â€¢ 17 custom commands for Drupal development workflow"
  echo "   â€¢ Theme development tools with Node.js/NPM support"
  echo "   â€¢ Cypress testing integration"
  echo "   â€¢ Drupal Recipe support"
  echo "   â€¢ Migration and backup utilities"
  echo "   â€¢ Redis add-on installed"
  echo "   â€¢ Solr add-on with DDEV configuration for search functionality"
  echo ""
  echo "ðŸ”§ Next steps:"
  echo "   1. Set your Pantheon machine token, if it's not already set:"
  echo "      ddev config global --web-environment-add=TERMINUS_MACHINE_TOKEN=your_token_here"
  echo "   2. Run 'ddev restart' to apply configuration changes"
  echo "   3. Run 'ddev init' to complete project initialization"
  echo "   4. Add Solr configuration to your settings.php (see below)"
  echo ""
  echo "ðŸ” Solr Configuration:"
  echo "   Add this configuration to web/sites/default/settings.php to connect to DDEV Solr."
  echo "   Note: Adjust the server machine name to match your project's Search API server."
  echo ""
  echo "   /**"
  echo "    * DDEV Solr Configuration"
  echo "    * Override Pantheon search configuration when in DDEV environment"
  echo "    */"
  echo "   if (getenv('IS_DDEV_PROJECT') == 'true') {"
  echo "     // Override any Pantheon search configuration for DDEV"
  echo "     \$config['search_api.server.pantheon_solr8']['backend_config']['connector_config']['host'] = 'solr';"
  echo "     \$config['search_api.server.pantheon_solr8']['backend_config']['connector_config']['port'] = '8983';"
  echo "     \$config['search_api.server.pantheon_solr8']['backend_config']['connector_config']['path'] = '/';"
  echo "     \$config['search_api.server.pantheon_solr8']['backend_config']['connector_config']['core'] = 'dev';"
  echo "     "
  echo "     // Alternative configuration if using different server name"
  echo "     \$config['search_api.server.solr']['backend_config']['connector_config']['host'] = 'solr';"
  echo "     \$config['search_api.server.solr']['backend_config']['connector_config']['port'] = '8983';"
  echo "     \$config['search_api.server.solr']['backend_config']['connector_config']['path'] = '/';"
  echo "     \$config['search_api.server.solr']['backend_config']['connector_config']['core'] = 'dev';"
  echo "   }"
  echo ""
  echo "ðŸ“š Run 'ddev help' to see available commands"
  echo ""

removal_action:
# Remove all installed components and add-ons
- |
  echo ""
  echo "ðŸ—‘ï¸ Removing Kanopi Pantheon Drupal Add-on..."
  echo ""
  
  # Remove Redis add-on
  echo "ðŸ“¦ Removing Redis add-on..."
  if ddev add-on remove ddev-redis 2>/dev/null; then
    echo "âœ… Redis add-on removed successfully"
  else
    echo "âš ï¸ Redis add-on removal failed or not found"
  fi
  
  # Remove Solr add-on
  echo "ðŸ“¦ Removing Solr add-on..."
  if ddev add-on remove ddev-drupal-solr 2>/dev/null; then
    echo "âœ… Solr add-on removed successfully"
  else
    echo "âš ï¸ Solr add-on removal failed or not found"
  fi
  
  # Remove all custom commands
  echo "ðŸ”§ Removing custom commands..."
  
  # Remove host commands
  rm -f commands/host/cypress 2>/dev/null || true
  rm -f commands/host/cypress-users 2>/dev/null || true
  rm -f commands/host/init 2>/dev/null || true
  rm -f commands/host/install-cypress 2>/dev/null || true
  rm -f commands/host/open 2>/dev/null || true
  rm -f commands/host/phpmyadmin 2>/dev/null || true
  rm -f commands/host/rebuild 2>/dev/null || true
  rm -f commands/host/refresh 2>/dev/null || true
  rm -f commands/host/solrtail.example 2>/dev/null || true
  rm -f commands/host/testenv 2>/dev/null || true
  rm -f commands/host/README.txt 2>/dev/null || true
  
  # Remove web commands
  rm -f commands/web/install-critical-tools 2>/dev/null || true
  rm -f commands/web/install-theme-tools 2>/dev/null || true
  rm -f commands/web/migrate-prep-db 2>/dev/null || true
  rm -f commands/web/npm 2>/dev/null || true
  rm -f commands/web/npx 2>/dev/null || true
  rm -f commands/web/recipe-apply 2>/dev/null || true
  rm -f commands/web/refresh 2>/dev/null || true
  rm -f commands/web/tickle 2>/dev/null || true
  rm -f commands/web/uuid-rm 2>/dev/null || true
  rm -f commands/web/README.txt 2>/dev/null || true
  
  echo "âœ… Custom commands removed"
  
  # Remove any remaining Redis command directories
  rm -rf commands/redis 2>/dev/null || true
  
  # Clean up empty directories
  rmdir commands/host 2>/dev/null || true
  rmdir commands/web 2>/dev/null || true
  rmdir commands 2>/dev/null || true
  
  echo ""
  echo "âœ… Kanopi Pantheon Drupal Add-on removed successfully!"
  echo "   â€¢ Redis and Solr add-ons uninstalled"
  echo "   â€¢ All 17 custom commands removed"
  echo "   â€¢ Environment variables preserved (remove manually if needed)"
  echo ""
  echo "ðŸ’¡ Tip: Run 'ddev restart' to apply changes"
  echo ""
