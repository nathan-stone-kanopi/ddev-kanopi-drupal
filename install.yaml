name: ddev-kanopi-pantheon-drupal

# Based on https://github.com/ddev/ddev/blob/HEAD/pkg/ddevapp/addons.go#L61
project_files:
- commands/

# DDEV version constraint
ddev_version_constraint: ">= v1.22.0"

# Pre-install actions
pre_install_actions:
# Collect user input for configuration
- |
  #ddev-description:Collecting configuration for Kanopi Pantheon Drupal Add-on
  echo ""
  echo "üîß Configuring Kanopi Pantheon Drupal Add-on..."
  echo ""
  
  # Check if running in non-interactive mode (for testing)
  if [ "${ADDON_NON_INTERACTIVE:-}" = "true" ]; then
    echo "ü§ñ Running in non-interactive mode (test environment)"
    
    # Use pre-set environment variables
    ADDON_THEME_PATH="${ADDON_THEME_PATH:-themes/custom/themename}"
    ADDON_THEME_NAME="${ADDON_THEME_NAME:-themename}"
    ADDON_PANTHEON_SITE="${ADDON_PANTHEON_SITE:-your-pantheon-site}"
    ADDON_PANTHEON_ENV="${ADDON_PANTHEON_ENV:-dev}"
    ADDON_MIGRATE_SOURCE="${ADDON_MIGRATE_SOURCE:-}"
    ADDON_MIGRATE_ENV="${ADDON_MIGRATE_ENV:-}"
    
    echo "üìÅ Theme path: $ADDON_THEME_PATH"
    echo "üé® Theme name: $ADDON_THEME_NAME"
    echo "üèõÔ∏è  Pantheon site: $ADDON_PANTHEON_SITE"
    echo "üåç Pantheon env: $ADDON_PANTHEON_ENV"
    echo "üì¶ Migration source: ${ADDON_MIGRATE_SOURCE:-'(not set)'}"
    echo "üåç Migration env: ${ADDON_MIGRATE_ENV:-'(not set)'}"
    
  else
    # Interactive mode - collect user input
    
    # THEME configuration
    printf "üìÅ Enter the path to your active Drupal theme (e.g., themes/custom/mytheme): "
    read ADDON_THEME_PATH
    if [ -z "$ADDON_THEME_PATH" ]; then
      ADDON_THEME_PATH="themes/custom/themename"
      echo "‚ö†Ô∏è  Using default theme path: $ADDON_THEME_PATH"
    fi
    
    # THEMENAME configuration
    printf "üé® Enter your theme name (e.g., mytheme): "
    read ADDON_THEME_NAME
    if [ -z "$ADDON_THEME_NAME" ]; then
      ADDON_THEME_NAME="themename"
      echo "‚ö†Ô∏è  Using default theme name: $ADDON_THEME_NAME"
    fi
    
    # PANTHEON_SITE configuration
    printf "üèõÔ∏è  Enter your Pantheon project machine name (e.g., my-site): "
    read ADDON_PANTHEON_SITE
    if [ -z "$ADDON_PANTHEON_SITE" ]; then
      echo "‚ùå PANTHEON_SITE is required for proper functionality"
      exit 1
    fi
    
    # PANTHEON_ENV configuration
    printf "üåç Enter default Pantheon environment for database pulls (dev/test/live) [dev]: "
    read ADDON_PANTHEON_ENV
    if [ -z "$ADDON_PANTHEON_ENV" ]; then
      ADDON_PANTHEON_ENV="dev"
    fi
    
    echo ""
    echo "Optional Migration Configuration:"
    echo "Press Enter to skip if you don't need migration support"
    echo ""
    
    # MIGRATE_DB_SOURCE configuration (optional)
    printf "üì¶ Enter migration source Pantheon project name (optional): "
    read ADDON_MIGRATE_SOURCE
    
    # MIGRATE_DB_ENV configuration (optional)
    printf "üåç Enter migration source environment (dev/test/live) (optional): "
    read ADDON_MIGRATE_ENV
  fi
  
  # Export variables for post-install use
  export ADDON_THEME_PATH
  export ADDON_THEME_NAME
  export ADDON_PANTHEON_SITE
  export ADDON_PANTHEON_ENV
  export ADDON_MIGRATE_SOURCE
  export ADDON_MIGRATE_ENV
  
  echo ""
  echo "‚úÖ Configuration collected successfully"

# Post-install actions
post_install_actions:
# Apply the collected configuration and detect Pantheon settings
- |
  echo ""
  echo "‚öôÔ∏è  Applying configuration..."
  
  # Apply collected configuration values with defaults
  ddev config --docroot=web
  ddev config --web-environment-add THEME=${ADDON_THEME_PATH:-themes/custom/themename}
  ddev config --web-environment-add THEMENAME=${ADDON_THEME_NAME:-themename}
  ddev config --web-environment-add PANTHEON_SITE=${ADDON_PANTHEON_SITE:-your-pantheon-site}
  ddev config --web-environment-add PANTHEON_ENV=${ADDON_PANTHEON_ENV:-dev}
  
  # Apply optional migration variables if provided
  if [ -n "${ADDON_MIGRATE_SOURCE:-}" ]; then
    ddev config --web-environment-add MIGRATE_DB_SOURCE=${ADDON_MIGRATE_SOURCE}
  fi
  
  if [ -n "${ADDON_MIGRATE_ENV:-}" ]; then
    ddev config --web-environment-add MIGRATE_DB_ENV=${ADDON_MIGRATE_ENV}
  fi
  
  echo "‚úÖ Configuration applied successfully"
  
  # Search for pantheon.yml and configure versions
  echo ""
  echo "üîç Searching for pantheon.yml to configure PHP and database versions..."
  
  PANTHEON_YML=""
  # Search in common locations relative to project root
  for path in "pantheon.yml" "../pantheon.yml" "../../pantheon.yml"; do
    if [ -f "$path" ]; then
      PANTHEON_YML="$path"
      echo "‚úÖ Found pantheon.yml at: $path"
      break
    fi
  done
  
  if [ -n "$PANTHEON_YML" ]; then
    # Extract PHP version
    PHP_VERSION=$(grep "^php_version:" "$PANTHEON_YML" | sed 's/php_version: *//' | tr -d '"' || echo "")
    if [ -n "$PHP_VERSION" ]; then
      echo "üêò Setting PHP version to: $PHP_VERSION"
      ddev config --php-version="$PHP_VERSION"
    fi
    
    # Extract database version
    DB_VERSION=$(grep -A1 "^database:" "$PANTHEON_YML" | grep "version:" | sed 's/.*version: *//' | tr -d '"' || echo "")
    if [ -n "$DB_VERSION" ]; then
      echo "üóÑÔ∏è  Setting database version to: $DB_VERSION"
      # Get current database version to check if change is needed
      CURRENT_DB=$(grep -A3 "database:" .ddev/config.yaml | grep "version:" | sed 's/.*version: *//' | tr -d '"' || echo "")
      
      if [ "$CURRENT_DB" != "$DB_VERSION" ]; then
        echo "üì¶ Changing database from $CURRENT_DB to $DB_VERSION"
        # Stop DDEV first to allow database change
        echo "‚èπÔ∏è  Stopping DDEV to change database version..."
        ddev stop || echo "‚ö†Ô∏è  DDEV stop failed, continuing..."
        
        # Use DDEV's debug migrate-database command to handle version change
        echo "üîÑ Migrating database to version $DB_VERSION..."
        if ! timeout 120 ddev debug migrate-database "mariadb:$DB_VERSION"; then
          echo "‚ö†Ô∏è  Database migration failed or timed out, trying alternative approach..."
          # Alternative: delete database and reconfigure
          ddev delete --omit-snapshot --yes 2>/dev/null || true
          ddev config --database="mariadb:$DB_VERSION" || echo "‚ö†Ô∏è  Database config failed"
        fi
        
        echo "üîÑ Starting DDEV with database version $DB_VERSION..."
        if ! timeout 120 ddev start; then
          echo "‚ùå DDEV start failed or timed out"
        fi
      else
        echo "‚úÖ Database version $DB_VERSION already configured"
      fi
    fi
    
    echo "‚úÖ Pantheon versions applied from pantheon.yml"
  else
    echo "‚ÑπÔ∏è  No pantheon.yml found, using default versions"
  fi
  
  # Install Redis add-on for all configurations
  echo ""
  echo "üì¶ Installing Redis add-on..."
  if ! timeout 180 ddev add-on get ddev/ddev-redis; then
    echo "‚ö†Ô∏è  Redis add-on installation failed or timed out"
  else
    echo "‚úÖ Redis add-on installed successfully"
  fi
  
  # Install Solr add-on for search functionality
  echo ""
  echo "üì¶ Installing Solr add-on..."
  if ! timeout 180 ddev add-on get ddev/ddev-drupal-solr; then
    echo "‚ö†Ô∏è  Solr add-on installation failed or timed out"
  else
    echo "‚úÖ Solr add-on installed successfully"
  fi

# Explain the installed components
- |
  echo ""
  echo "‚úÖ Kanopi Pantheon Drupal Add-on installed successfully!"
  echo ""
  echo "üì¶ Installed components:"
  echo "   ‚Ä¢ Enhanced Pantheon provider with smart backup management"
  echo "   ‚Ä¢ 17 custom commands for Drupal development workflow"
  echo "   ‚Ä¢ Theme development tools with Node.js/NPM support"
  echo "   ‚Ä¢ Cypress testing integration"
  echo "   ‚Ä¢ Drupal Recipe support"
  echo "   ‚Ä¢ Migration and backup utilities"
  echo "   ‚Ä¢ Redis add-on installed"
  echo "   ‚Ä¢ Solr add-on with DDEV configuration for search functionality"
  echo ""
  echo "üîß Next steps:"
  echo "   1. Set your Pantheon machine token, if it's not already set:"
  echo "      ddev config global --web-environment-add=TERMINUS_MACHINE_TOKEN=your_token_here"
  echo "   2. Run 'ddev restart' to apply configuration changes"
  echo "   3. Run 'ddev init' to complete project initialization"
  echo "   4. Add Solr configuration to your settings.php (see below)"
  echo ""
  echo "üîç Solr Configuration:"
  echo "   Add this configuration to web/sites/default/settings.php to connect to DDEV Solr."
  echo "   Note: Adjust the server machine name to match your project's Search API server."
  echo ""
  echo "   /**"
  echo "    * DDEV Solr Configuration"
  echo "    * Override Pantheon search configuration when in DDEV environment"
  echo "    */"
  echo "   if (getenv('IS_DDEV_PROJECT') == 'true') {"
  echo "     // Override any Pantheon search configuration for DDEV"
  echo "     \$config['search_api.server.pantheon_solr8']['backend_config']['connector_config']['host'] = 'solr';"
  echo "     \$config['search_api.server.pantheon_solr8']['backend_config']['connector_config']['port'] = '8983';"
  echo "     \$config['search_api.server.pantheon_solr8']['backend_config']['connector_config']['path'] = '/';"
  echo "     \$config['search_api.server.pantheon_solr8']['backend_config']['connector_config']['core'] = 'dev';"
  echo "     "
  echo "     // Alternative configuration if using different server name"
  echo "     \$config['search_api.server.solr']['backend_config']['connector_config']['host'] = 'solr';"
  echo "     \$config['search_api.server.solr']['backend_config']['connector_config']['port'] = '8983';"
  echo "     \$config['search_api.server.solr']['backend_config']['connector_config']['path'] = '/';"
  echo "     \$config['search_api.server.solr']['backend_config']['connector_config']['core'] = 'dev';"
  echo "   }"
  echo ""
  echo "üìö Run 'ddev help' to see available commands"
  echo ""

removal_action:
# Note what's being removed
- |
  echo "Removing Kanopi Pantheon Drupal Add-on..."
