#!/usr/bin/env bash

## Description: Initialize stack and testing environment in DDEV.
## Usage: pantheon-testenv [environment_name] [optional profile_or_recipe]
## Example: ddev pantheon-testenv my-env minimal
## Aliases: pantheon:testenv,testenv

#ddev-generated

# Abort if anything fails
set -e

#-------------------------- Helper functions ------------------------------

green='\033[0;32m'
yellow='\033[1;33m'
NC='\033[0m'
divider='===================================================\n'

#-------------------------- Execution -------------------------------------

# Check for help flag or no arguments
if [ "$1" = "--help" ] || [ "$1" = "-h" ] || [ -z "$1" ]; then
    echo -e "\n  ğŸš§  Initialize stack and testing environment in DDEV."
    echo -e "\n  ğŸ”¹  Usage: ddev pantheon-testenv <environment_name> [optional profile_or_recipe]"
    echo -e "\n  ğŸ“–  Example: ddev pantheon-testenv my-env minimal"
    echo -e "\n  ğŸ¯  This command sets up a full testing environment with Cypress,"
    echo -e "      installs Drupal with the specified profile, and provides login link."
    echo -e "\n  ğŸ—ï¸  The profile defaults to 'minimal' if not specified."
    exit 0
fi

# Set the variables from the inputs.
# Default to "minimal" profile if not provided.
ENVNAME=$1
PROFILERECIPE=${2:-minimal}

echo -e "ğŸš§ ${yellow} Initializing test environment: ${ENVNAME} ${NC} ğŸš§"
echo -e "${green}${divider}${NC}"

# Ensure we are in the project root.
cd ${DDEV_APPROOT}

echo -e "ğŸš§ ${yellow} Initializing Cypress.${NC} ğŸš§"
echo -e "${green}${divider}${NC}"
ddev cypress-install

# Site initialization.
echo -e "ğŸš§ ${yellow} Composer install.${NC} ğŸš§"
echo -e "${green}${divider}${NC}"
ddev composer install

# Run site installation with the given profile/recipe
ddev drush si -y $PROFILERECIPE

# Log in
echo -e "ğŸ”‘ ${yellow} Logging you in. ${NC} ğŸ”‘"
ddev drush uli

# Complete
echo -e "ğŸ‰ ${yellow} Build complete!!! ${NC} ğŸ‰"
echo -e "${green}${divider}${NC}"
